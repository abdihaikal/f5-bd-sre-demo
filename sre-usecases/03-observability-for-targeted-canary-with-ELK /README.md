# Getting Started - SRE ELK Stack Deployment 
## Summary
The ELK(Elasticsearch, Logstash, Kibana) is the acronym for three open source projects. 
Elasticsearch is a search and analytics engine and Logstash is a server-side data processing pipeline that ingests data from multiple sources, transforms it and send to Elasticsearch.
Kibana let’s users visualize data with charts and graphs in Elasticsearch.
So we will use ELK to analyze app performance and visualize it on centralized dashboard to see/check easily correlation for N-S traffic and E-W traffic.<br>

![ELK_Topolgy](images/elk_topology.png)<br>


## Prerequisites
Here is needed to prepare an ELK stack server outside of the openshift cluster and you can refer this site ( https://www.digitalocean.com/community/tutorials/how-to-install-elasticsearch-logstash-and-kibana-elastic-stack-on-ubuntu-18-04 ) to install it and also see the logstash configuration ![file](./logstash.conf) used for this demo.


## Use case scenario
This use case is a part of use ![case#1(targeted canary)](https://github.com/f5devcentral/f5-bd-sre-demo/tree/master/sre-usecases/01-targeted-canary) as an extension feature. If you have been followed each steps at use case#1, some configurations are already configured in openshift cluster and UUID is generated by iRule on BIG-IP when traffic is arriving at BIG-IP then it is inserting to http header. All of UUIDs with access logs are sending to ELK stack server then we can see what we want to see/check such as user location, response time by user location, response time BIG-IP and NGINX, etc.


## Setup and Configuration

### 1. Create HSL pool, iRule on BIG-IP<br>
 We need to create pool with ELK stack server on BIG-IP then this pool member will be used by ![iRules](./iRules) to send access logs from BIG-IP to ELK stack.<br>
![ELK_Pool](images/elk_pool.png)
<br>
 
_The ELK server IP address is 10.69.33.1 and 8516 port is listening to get logs so pool service port should be 8516._<br>
![ELK_Pool_Member](images/elk_pool_member.png)

_Then we need to create new VIP with bookinfo pool which created at previous case._<br>
![ELK_VIP](images/elk_vip.png)
<br>

_The new VIP name is a bookinfo-EdgeGW and the bookinfo pool is defined for default pool like below. The applied iRules name is elk_hsl_irule for this VIP so all of access logs will have the UUID and send to ELK server by this iRule._<br>
![ELK_Default_Pool](images/elk_default_pool.png)
<br>

_Hereby, it’s ready to use ELK stack for BIG-IP access logs, NGINX apps in openshift cluster but we don’t need any configuration for NGINX apps at this step why it’s already pushed at the first case in config-map._<br>
![ELK_Log](images/elk_log.png)
<br><br><br>

### 2. Customize Kibana Dashboard<br>
 If all of configurations are ready to use in proper, all of defined logs are saving in ELK server. We are able to customize a  dashboard to see visualized useful information which user location, response time by location etc.<br>
This page is a bit long to show step by step but the contents are too easy. don't worry about that.<br>
Let us see how it works<br>

<br>_step1) open your browser and go to ELK server( http://x.x.x.x:5601 ) then you can see a Kibana main window like following_
![Kibana1_main](images/Kibana1_main.png)
<br>

<br>_step2) Then press control icon from left side-menu to go to management page_
![Kibana2_management](images/Kibana2_management.png)
<br>

<br>_step3) We can see the management page then press "Index Management" menu from the page_
![Kibana3_management_detail](images/Kibana3_management_detail.png)
<br>

<br>_step4) Now, we can see index management page and see index name which defined them in ![logstash.conf](./logstash.conf) file._
![Kibana4_index_management](images/Kibana4_index_management.png)
<br>_You can check more detail to index manage from_ ![here](https://www.elastic.co/guide/en/kibana/current/managing-indices.html)
<br>

<br>_step5) Next step is that we will make visualize with our indexed data to add it into dashboard so let's move to visualize tab then press "Create new visualization"_
![Kibana5_visualize](images/Kibana5_visualize.png)
<br>

<br>_step6) Choose one of the visualization data type and we will use coordinate Map in here_
![Kibana6_create](images/Kibana6_create.png)
<br>

<br>_step7) Choose source what you want to use and we will choose "logstash-f5-nginx-access" for demo_ 
![Kibana7_source](images/Kibana7_source.png)
<br>

<br>_step8_metrics) We need to set Metrics and Buckets on this step. aggregation is Average and field is response_time_ms then custom label is Response Time_ 
![Kibana8_Metrics](images/Kibana8_Metrics.png)
<br>

<br>_step8_buckets) At the Buckets, aggregation is Geohash and field is geoip.location as default and other options remain as default then custom label type Locations_ 
![Kibana8_Bucktes](images/Kibana8_Buckets.png)
<br>

<br>_step9_apply) Traffic generator is working in background so we can see the result like follwoing after update metrics/buckets and press apply change button_ 
![Kibana9_apply](images/Kibana9_apply_save.png)
<br>

<br>_step9_save) We need to save the visualize configuration and we will save as ASEAN_CES_ 
![Kibana9_save](images/Kibana9_save_name.png)
<br>_We just created one sample visualize data but if you want to more visualize data, you can repeate step5 to step9 as much as you want to create.
<br>

<br>_step10_dashboard)We will go to create dashboard to add the visualize date on it. Press "Dashboard" button from left side-menu_ 
![Kibana10_dashboard](images/Kibana10_dashboard.png)
<br>

<br>_step10_crate) Press "Create new dashboard" button_ 
![Kibana10_create](images/Kibana10_dashboard_create.png)
<br>

<br>_step10_add_panel) Press "Add" button then we need to choose panels in here what we created the visualize. The ASEAN_CES was just created one at step9_ 
![Kibana10_add_panel](images/Kibana10_add_panel.png)
![Kibana10_choose_panel](images/Kibana10_select_panel.png)
<br>

<br>_step10_save) The visualize 'ASEAN_CES' is displaying on the dashboard now.We will see only one in here but if you created some more at step9, you can add all of them in here_ 
![Kibana10_save](images/Kibana10_dashboard_save.png)
<br>

<br>_step10_dashboard) We need to save the dashboard so press "Save" button then type the dashboard title which "ASEAN_CES_Dashboard"_ 
![Kibana10_dashboard_name](images/Kibana10_dashboard_name.png)
![Kibana10_dashboard_final](images/Kibana10_dashboard_final.png)
<br>

<br>_step11_move) Now, we are ready to see dashboard what we created visualize. Press "Dashboard" icon from left side-menu then we can see the dashboard name which just saved name is "ASEAN_CES_Dashboard"_
![Kibana11_move_dashboard](images/Kibana11_move_dashboard.png)
<br>

<br>_step11_update> we can see just saved dashboard and visualize data in here then Press the 'Update' button of top right. Then we can see the updated data in the visualize panel like below
![Kibana11_dashboard_update](images/Kibana11_dashboard_update.png)
![Kibana11_dashboard_update](images/Kibana11_dashboard_refresh.png)
<br><br><br>

### 3. ELK Dashboard Sampels
![ELK_Pool](images/elk_map.png)


![ELK_Pool](images/elk_bigip.png)


![ELK_Pool](images/elk_response.png)


![ELK_Pool](images/elk_dot.png)




